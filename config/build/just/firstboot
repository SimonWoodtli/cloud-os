#!/bin/sh
#FIXME in F38 flathub ships with it, so this test would fail need to check for options instead of name
[ "$(flatpak remotes | grep -q fedora; echo $?)" -eq 0 ] || { echo "Firstboot already ran"; exit 0; }
############################### utilities ##############################
createNewProfile() {
    local dir=/org/gnome/terminal/legacy/profiles:
    local profileIds=(\
      $(dconf list $dir/ | grep ^: | sed 's/\///g' | sed 's/://g'))
    local profileName="$1"
    local profileIdsOld="$(dconf read "$dir"/list | tr -d "]")"
    local profileId="$2"

    [ -z "$profileIdsOld" ] && local profileIdsOld="["  # if there's no `list` key
    [ ${#profileIds[@]} -gt 0 ] && local delimiter=,  # if the list is empty

    dconf write $dir/list \
        "${profileIdsOld}${delimiter} '$profileId']"
    dconf write "$dir/:$profileId"/visible-name "'$profileName'"
}
################################# main #################################
read -s -p "[sudo] password for $(whoami): " password
(
echo "# Waiting for Internet connection"
until /usr/bin/ping -q -c 1 flathub.org; do sleep 1; done
echo "00"

echo "# Removing Filtered Flathub Repository"
sudo -S /usr/bin/flatpak remote-delete flathub --force <<< "$password" ||:
if [ "$?" != 0 ] ; then
        zenity --error \
          --text="Removing Filtered Flathub Repo Failed"
        exit 1
fi
echo "3"

echo "# Enabling Flathub Repository"
/usr/bin/flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
if [ "$?" != 0 ] ; then
        zenity --error \
          --text="Adding Flathub Repo Failed"
        exit 1
fi
echo "5"

echo "# Replacing Fedora Flatpaks with Flathub Ones (this may take a while)"
/usr/bin/flatpak install --user --noninteractive org.gnome.Platform//43
/usr/bin/flatpak install --user --noninteractive --reinstall flathub $(flatpak list --app-runtime=org.fedoraproject.Platform --columns=application | tail -n +1 )
if [ "$?" != 0 ] ; then
        zenity --error \
          --text="Replacing Fedora Flatpaks Failed"
        exit 1
fi
echo "20"

echo "Removing all preinstalled Flatpaks"
/usr/bin/flatpak remove --system --noninteractive --all ||:
if [ "$?" != 0 ] ; then
        zenity --error \
          --text="Removing all preinstalled flatpaks failed"
        exit 1
fi

echo "# Removing Fedora Flatpak Repository"
sudo -S /usr/bin/flatpak remote-delete fedora --force <<< "$password" ||:
if [ "$?" != 0 ] ; then
        zenity --error \
          --text="Removing Fedora Flatpak Repo Failed"
        exit 1
fi
echo "25"

echo "# Installing flatpaks from recipe"
flatpaks=$(yq '.flatpaks[]' < /usr/share/cloud-os/cloud-os-just/recipe.yml)
flatpaks_count=$(yq '.flatpaks[]' < /usr/share/cloud-os/cloud-os-just/recipe.yml | wc -l)
i=0
for pkg in $flatpaks; do
  echo "# Installing ${pkg}"
  /usr/bin/flatpak install --user --noninteractive flathub $pkg
  if [ "$?" != 0 ] ; then
          zenity --error \
            --text="Installing ${pkg} Failed"
          exit 1
  fi
  i=$((i+1))
  # Automatically calculates evenly spaced progess using bc, cuts everything after decimal point.
  echo "${i}/${flatpaks_count} * (95-30) + 30" | bc -l | cut -d "." -f1 
done

echo "# Installing pipx"
python3 -m pip install --user pipx

echo "# Installing gnome-extensions-cli"
pipx install gnome-extensions-cli --system-site-packages

echo "# Installing extensions from recipe"
extensions=$(yq '.extensions[]' < /usr/share/cloud-os/cloud-os-just/recipe.yml)
i=0
for pkg in $extensions; do
  echo "# Installing ${pkg}"
  $HOME/.local/bin/gnome-extensions-cli install $pkg
  if [ "$?" != 0 ] ; then
          zenity --error \
            --text="Installing ${pkg} Failed"
          exit 1
  fi
  sleep 2
  i=$((i+1))
  # Automatically calculates evenly spaced progess using bc, cuts everything after decimal point.
  echo "${i}/${flatpaks_count} * (95-30) + 30" | bc -l | cut -d "." -f1 
done

echo "Create gnome-terminal profiles"
createNewProfile gruvbox-host eaa70d0f-2bff-4c94-8714-5c8815cf8b0f
createNewProfile gruvbox-workspace 2ea51c17-a89c-4151-af02-925016c2a29a
createNewProfile gruvbox-alpine 4c3035f9-08ef-4956-8cf2-c11fe365d146

echo "Enabling Flatpak auto update"
/usr/bin/systemctl --user enable --now flatpak-user-update.timer
if [ "$?" != 0 ] ; then
        zenity --error \
          --text="Setting Flatpak Autoupdate Failed"
        exit 1
fi
echo "100"

) | 
     
   zenity --progress --title="cloud-os Desktop Firstboot" --percentage=0 --auto-close --no-cancel --width=300

if [ "$?" != 0 ] ; then
        zenity --error \
          --text="Firstboot Configuration Error"
fi
